name: Build SQLCipher (Windows MinGW-w64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'SQLCipher tag (ex: v4.10.0)'
        required: true
        default: 'v4.10.0'

jobs:
  build-win:
    runs-on: windows-latest

    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4

      - name: Instalar MSYS2 e depend√™ncias
        run: |
          choco install msys2 --no-progress -y
          C:\tools\msys64\usr\bin\bash -lc "pacman -Syu --noconfirm"
          C:\tools\msys64\usr\bin\bash -lc "
            pacman -S --noconfirm \
              base-devel \
              autoconf \
              automake \
              libtool \
              make \
              mingw-w64-x86_64-gcc \
              mingw-w64-x86_64-openssl \
              mingw-w64-x86_64-pkg-config \
              mingw-w64-x86_64-tcl
          "

      - name: Baixar SQLCipher
        shell: pwsh
        run: |
          echo "üîπ Baixando SQLCipher..."
          curl -L -o sqlcipher.zip https://github.com/sqlcipher/sqlcipher/archive/refs/tags/${{ github.event.inputs.tag }}.zip
          tar -xf sqlcipher.zip
          $folder = Get-ChildItem -Directory | Where-Object { $_.Name -like 'sqlcipher-*' } | Select-Object -First 1
          if (-not $folder) { throw "‚ùå Diret√≥rio sqlcipher-* n√£o encontrado ap√≥s extra√ß√£o!" }
          Rename-Item -Path $folder.FullName -NewName "sqlcipher"

      - name: Gerar amalgamation (sqlite3.c e shell.c)
        shell: pwsh
        run: |
          echo "üîπ Gerando arquivos sqlite3.c e shell.c..."
          C:\tools\msys64\usr\bin\bash -lc "
            cd /d/a/${{ github.event.repository.name }}/${{ github.event.repository.name }}/sqlcipher
            autoreconf -fi
            ./configure --enable-tempstore=yes --disable-tcl --with-crypto-lib=openssl
            make sqlite3.c shell.c
          "
          echo "‚úÖ Arquivos sqlite3.c e shell.c gerados."

      - name: Compilar SQLCipher (DLL e EXE)
        shell: pwsh
        run: |
          echo "üîπ Compilando SQLCipher..."
          C:\tools\msys64\usr\bin\bash -lc "
            cd /d/a/${{ github.event.repository.name }}/${{ github.event.repository.name }}/sqlcipher
            export PATH=/mingw64/bin:\$PATH

            echo 'üîπ Compilando biblioteca principal (DLL)...'
            gcc -DSQLITE_HAS_CODEC \
                -DSQLCIPHER_CRYPTO_OPENSSL \
                -DSQLITE_TEMP_STORE=2 \
                -DSQLITE_EXTRA_INIT=sqlcipher_extra_init \
                -DSQLITE_EXTRA_SHUTDOWN=sqlcipher_extra_shutdown \
                -DHAVE_STDINT_H \
                -I. \
                -I/mingw64/include \
                sqlite3.c \
                -shared -o sqlcipher.dll \
                -L/mingw64/lib -lcrypto -lssl

            echo 'üîπ Compilando execut√°vel CLI...'
            gcc shell.c -o sqlcipher.exe \
                -I. \
                -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL \
                -DSQLITE_TEMP_STORE=2 \
                -DSQLITE_EXTRA_INIT=sqlcipher_extra_init \
                -DSQLITE_EXTRA_SHUTDOWN=sqlcipher_extra_shutdown \
                -DHAVE_STDINT_H \
                -L. -lsqlcipher -L/mingw64/lib -lcrypto -lssl
          "

      - name: Empacotar artefatos
        shell: pwsh
        run: |
          echo "üîπ Compactando arquivos compilados..."
          Compress-Archive -Path sqlcipher/sqlcipher.dll,sqlcipher/sqlcipher.exe -DestinationPath sqlcipher_build.zip

      - name: Publicar artefatos
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows-build
          path: sqlcipher_build.zip
