name: Build SQLCipher (Windows MinGW-w64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'SQLCipher tag (ex: v4.10.0)'
        required: true
        default: 'v4.10.0'

jobs:
  build-win:
    runs-on: windows-latest

    steps:
      - name: ğŸ”¹ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ”¹ Instalar dependÃªncias MSYS2 e OpenSSL
        run: |
          C:\msys64\usr\bin\bash -lc "pacman -Syu --noconfirm"
          C:\msys64\usr\bin\bash -lc "pacman -S --noconfirm mingw-w64-x86_64-gcc mingw-w64-x86_64-openssl make"

      - name: ğŸ”¹ Detectar e gerar sqlite3.c e shell.c
        shell: pwsh
        run: |
          echo "ğŸ”¹ Procurando diretÃ³rio que contÃ©m 'configure'..."
          $configurePath = Get-ChildItem -Recurse -Filter configure | Select-Object -First 1
          if (-not $configurePath) { throw "âŒ Arquivo 'configure' nÃ£o encontrado em lugar nenhum!" }

          $configureDir = Split-Path $configurePath.FullName
          echo "ğŸ“ DiretÃ³rio detectado: $configureDir"

          echo "ğŸ”¹ Gerando arquivos sqlite3.c e shell.c manualmente..."
          C:\msys64\usr\bin\bash -lc "cd '$configureDir' && ./configure --enable-tempstore=yes CFLAGS='-DSQLITE_HAS_CODEC' && make sqlite3.c shell.c"

      - name: ğŸ”¹ Preparar pasta build
        shell: pwsh
        run: |
          $srcDir = (Get-ChildItem -Recurse -Filter sqlite3.c | Select-Object -First 1).DirectoryName
          if (-not $srcDir) { throw "âŒ NÃ£o foi possÃ­vel encontrar sqlite3.c" }

          echo "ğŸ“ Copiando arquivos de: $srcDir"
          if (-not (Test-Path "build")) { mkdir build }

          Copy-Item "$srcDir\sqlite3.c" "$srcDir\shell.c" "$srcDir\sqlite3.h" "$srcDir\sqlite3ext.h" build -Force -ErrorAction SilentlyContinue

      - name: ğŸ”¹ Compilar SQLCipher (DLL + EXE)
        shell: pwsh
        run: |
          echo "ğŸ”¹ Ajustando PATH..."
          $env:PATH = "C:\msys64\mingw64\bin;$env:PATH"

          cd build
          echo "ğŸ“‚ Local atual: $(Get-Location)"
          echo "ğŸ“„ ConteÃºdo da pasta build:"
          Get-ChildItem

          $sqlite3Path = (Get-ChildItem -Filter sqlite3.c | Select-Object -First 1).FullName
          $shellPath   = (Get-ChildItem -Filter shell.c   | Select-Object -First 1).FullName

          if (-not $sqlite3Path) { throw "âŒ sqlite3.c nÃ£o encontrado!" }
          if (-not $shellPath) { throw "âŒ shell.c nÃ£o encontrado!" }

          echo "ğŸ”¹ Compilando biblioteca principal (DLL)..."
          gcc -O2 -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL -DSQLITE_TEMP_STORE=2 -DHAVE_STDINT_H -I. "$sqlite3Path" -shared -o sqlcipher.dll -L/mingw64/lib -lcrypto -lssl

          echo "ğŸ”¹ Compilando executÃ¡vel CLI..."
          gcc -O2 -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL -DSQLITE_TEMP_STORE=2 -DHAVE_STDINT_H -I. "$shellPath" -o sqlcipher.exe -L/mingw64/lib -lcrypto -lssl

      - name: ğŸ”¹ Compactar artefatos
        shell: pwsh
        run: |
          Compress-Archive -Path build\* -DestinationPath build\sqlcipher-windows.zip -Force

      - name: ğŸ”¹ Publicar artefatos (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows
          path: build/sqlcipher-windows.zip
