name: Build SQLCipher (Windows)

on:
  workflow_dispatch:

jobs:
  build-sqlcipher:
    runs-on: windows-latest

    env:
      MSYSTEM: MINGW64
      TAG: v4.10.0
      MSYS2_ARG_CONV_EXCL: "*"

    steps:
      - name: üîπ Instalar MSYS2 e depend√™ncias
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            git
            make
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-zlib

      - name: üîπ Clonar SQLCipher e compilar
        shell: msys2 {0}
        run: |
          set -euo pipefail

          echo "üîπ Clonando SQLCipher tag: $TAG"
          if [ -d sqlcipher ]; then
            echo "üßπ Limpando diret√≥rio antigo..."
            rm -rf sqlcipher
          fi

          git clone https://github.com/sqlcipher/sqlcipher.git sqlcipher
          cd sqlcipher
          git fetch --tags --quiet || true
          git checkout "$TAG" || git checkout "tags/$TAG" || true

          echo "‚úÖ Reposit√≥rio pronto (tag $TAG)"
          git rev-parse --short HEAD

          install_dir="$(pwd)/build/install"
          mkdir -p "$install_dir"

          export CFLAGS="-O2 \
            -DSQLITE_HAS_CODEC \
            -DSQLCIPHER_CRYPTO_OPENSSL \
            -DSQLITE_THREADSAFE=1 \
            -DSQLITE_TEMP_STORE=2 \
            -DSQLITE_EXTRA_INIT=sqlcipher_extra_init \
            -DSQLITE_EXTRA_SHUTDOWN=sqlcipher_extra_shutdown \
            -I/mingw64/include"

          export LDFLAGS="-L/mingw64/lib -lssl -lcrypto -lz"

          echo "CFLAGS: $CFLAGS"
          echo "LDFLAGS: $LDFLAGS"

          echo "üîπ Executando ./configure..."
          ./configure \
            --prefix="$install_dir" \
            CFLAGS="$CFLAGS" \
            LDFLAGS="$LDFLAGS" \
            --enable-tempstore=yes \
            --enable-shared \
            --enable-static \
            --disable-tcl \
            || { echo "‚ö†Ô∏è configure falhou"; exit 1; }

          echo "üîπ Compilando com make..."
          make -j"$(nproc)" || { echo "‚ùå make falhou"; exit 1; }

          echo "üîπ Instalando..."
          make install || { echo "‚ùå make install falhou"; exit 1; }

          echo "‚úÖ Build completo!"
          echo "üì¶ Artefatos instalados em: $install_dir"

      - name: üì§ Upload de artefatos (bin, lib, include)
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows-build
          path: sqlcipher/build/install/
