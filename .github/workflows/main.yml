name: Build SQLCipher (Windows MinGW-w64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'SQLCipher tag (ex: v4.10.0)'
        required: true
        default: 'v4.10.0'

jobs:
  build-win:
    runs-on: windows-latest
    steps:
      - name: ðŸ”¹ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”¹ Instalar dependÃªncias
        run: |
          choco install -y msys2
          C:\msys64\usr\bin\bash -lc "pacman -Syu --noconfirm && pacman -S --noconfirm git mingw-w64-x86_64-gcc mingw-w64-x86_64-openssl make zlib-devel"

      - name: ðŸ”¹ Baixar SQLCipher versÃ£o ${{ github.event.inputs.tag }}
        run: |
          git clone https://github.com/sqlcipher/sqlcipher.git
          cd sqlcipher
          git checkout ${{ github.event.inputs.tag }}

      - name: ðŸ”¹ Compilar SQLCipher
        shell: bash
        run: |
          cd sqlcipher
          ./configure --disable-tcl --with-crypto-lib=openssl CFLAGS="-DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL -DSQLITE_TEMP_STORE=2 -DSQLITE_EXTRA_INIT=sqlcipher_extra_init -DSQLITE_EXTRA_SHUTDOWN=sqlcipher_extra_shutdown"
          make -j$(nproc)

      - name: ðŸ“¦ Empacotar artefatos
        run: |
          mkdir -p build
          cp sqlcipher/sqlite3.exe build/sqlcipher.exe || true
          cp sqlcipher/.libs/libsqlcipher.dll build/sqlcipher.dll || true
          cp sqlcipher/sqlite3.h build/ || true
          cp sqlcipher/sqlite3ext.h build/ || true

      - name: ðŸ’¾ Upload de artefatos
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows
          path: build
