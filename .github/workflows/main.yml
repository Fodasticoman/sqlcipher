name: Build SQLCipher (Windows MinGW-w64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'SQLCipher tag (ex: v4.10.0)'
        required: true
        default: 'v4.10.0'

jobs:
  build-win:
    runs-on: windows-latest

    steps:
      - name: ğŸ”¹ Preparar ambiente
        shell: pwsh
        run: |
          echo "ğŸ”¹ Atualizando e instalando dependÃªncias..."
          choco install msys2 --no-progress -y
          C:\tools\msys64\usr\bin\bash -lc "pacman -Sy --noconfirm mingw-w64-x86_64-toolchain mingw-w64-x86_64-openssl make autoconf"

      - name: ğŸ”¹ Clonar SQLCipher
        shell: bash
        run: |
          echo "ğŸ”¹ Baixando SQLCipher versÃ£o ${{ github.event.inputs.tag }}"
          git clone https://github.com/sqlcipher/sqlcipher.git
          cd sqlcipher
          git checkout ${{ github.event.inputs.tag }}

      - name: âš™ï¸ Gerar sqlite3.c e shell.c
        shell: bash
        run: |
          cd sqlcipher
          echo "ğŸ”¹ Executando autoconf..."
          ./configure --disable-tcl
          echo "ğŸ”¹ Gerando arquivos amalgamados..."
          make sqlite3.c || true
          make shell.c || true

      - name: ğŸ§± Compilar SQLCipher (DLL + EXE)
        shell: pwsh
        run: |
          $env:PATH = "C:\msys64\mingw64\bin;$env:PATH"
          cd sqlcipher
          echo "ğŸ”¹ Compilando sqlite3.c..."
          gcc -O2 -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL -DSQLITE_TEMP_STORE=2 -DSQLITE_THREADSAFE=1 -DSQLITE_API=__declspec(dllexport) -I"C:\msys64\mingw64\include" -c sqlite3.c -o sqlite3.o
          
          echo "ğŸ”¹ Gerando DLL..."
          gcc -shared -o libsqlcipher.dll sqlite3.o -lcrypto -lssl -lz -L"C:\msys64\mingw64\lib"
          
          echo "ğŸ”¹ Gerando EXE..."
          gcc -O2 shell.c -o sqlite3.exe -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL -I. -L. -lsqlcipher -lcrypto -lssl -lz

      - name: ğŸ“¦ Empacotar artefatos
        shell: pwsh
        run: |
          cd sqlcipher
          echo "ğŸ”¹ Empacotando arquivos..."
          Compress-Archive -Path sqlite3.exe,libsqlcipher.dll,sqlite3.h,sqlite3ext.h -DestinationPath sqlcipher-windows.zip

      - name: ğŸ“¤ Publicar build
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows
          path: sqlcipher/sqlcipher-windows.zip
