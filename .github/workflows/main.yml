name: Build SQLCipher (Windows MinGW-w64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'SQLCipher tag (ex: v4.10.0)'
        required: true
        default: 'v4.10.0'

jobs:
  build-win:
    runs-on: windows-latest
    steps:
      - name: ğŸ§© Baixar cÃ³digo-fonte SQLCipher
        run: |
          git clone https://github.com/sqlcipher/sqlcipher.git
          cd sqlcipher
          git checkout ${{ github.event.inputs.tag }}

      - name: âš™ï¸ Instalar MSYS2 e dependÃªncias
        shell: pwsh
        run: |
          echo "ğŸ”¹ Instalando MSYS2..."
          choco install msys2 --no-progress -y
          echo "ğŸ”¹ Instalando pacotes base..."
          C:\msys64\usr\bin\bash -lc "pacman -S --noconfirm --needed mingw-w64-x86_64-gcc mingw-w64-x86_64-openssl make autoconf automake libtool pkgconf"

      - name: ğŸ—ï¸ Gerar arquivos sqlite3.c e shell.c
        shell: pwsh
        run: |
          echo "ğŸ”¹ Entrando no diretÃ³rio SQLCipher..."
          cd sqlcipher
          echo "ğŸ”¹ Preparando scripts de build..."
          C:\msys64\usr\bin\bash -lc "cd /d/a/_temp && cd ../../_work/${{ github.event.repository.name }}/${{ github.event.repository.name }}/sqlcipher && autoreconf -fi"
          echo "ğŸ”¹ Gerando arquivos com make..."
          C:\msys64\usr\bin\bash -lc "cd /d/a/_temp && cd ../../_work/${{ github.event.repository.name }}/${{ github.event.repository.name }}/sqlcipher && make sqlite3.c shell.c || true"

      - name: ğŸ” Listar arquivos gerados (.c)
        shell: pwsh
        run: |
          echo "ğŸ” Verificando onde estÃ£o sqlite3.c e shell.c..."
          Get-ChildItem -Recurse -Filter sqlite3.c | ForEach-Object { $_.FullName }
          Get-ChildItem -Recurse -Filter shell.c | ForEach-Object { $_.FullName }

      - name: ğŸ§± Compilar SQLCipher (DLL + CLI)
        shell: pwsh
        run: |
          echo "ğŸ”¹ Ajustando PATH..."
          $env:PATH = "C:\msys64\mingw64\bin;$env:PATH"

          cd sqlcipher
          $sqlite3Path = (Get-ChildItem -Recurse -Filter sqlite3.c | Select-Object -First 1).FullName
          $shellPath   = (Get-ChildItem -Recurse -Filter shell.c   | Select-Object -First 1).FullName

          if (-not $sqlite3Path) { throw "âŒ sqlite3.c nÃ£o encontrado!" }
          if (-not $shellPath) { throw "âŒ shell.c nÃ£o encontrado!" }

          echo "ğŸ”¹ Compilando biblioteca principal (DLL)..."
          gcc -O2 -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL -DSQLITE_TEMP_STORE=2 -DHAVE_STDINT_H -I. "$sqlite3Path" -shared -o sqlcipher.dll -L/mingw64/lib -lcrypto -lssl

          echo "ğŸ”¹ Compilando executÃ¡vel CLI..."
          gcc -O2 -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL -DSQLITE_TEMP_STORE=2 -DHAVE_STDINT_H -I. "$shellPath" -o sqlcipher.exe -L/mingw64/lib -lcrypto -lssl

      - name: ğŸ“¦ Compactar arquivos compilados
        shell: pwsh
        run: |
          echo "ğŸ”¹ Compactando arquivos compilados..."
          if (!(Test-Path "sqlcipher/sqlcipher.dll")) { throw "âŒ sqlcipher.dll nÃ£o encontrado!" }
          if (!(Test-Path "sqlcipher/sqlcipher.exe")) { throw "âŒ sqlcipher.exe nÃ£o encontrado!" }

          Compress-Archive -Path sqlcipher/sqlcipher.dll,sqlcipher/sqlcipher.exe,sqlcipher/sqlite3.h,sqlcipher/sqlite3ext.h -DestinationPath sqlcipher-windows.zip
          echo "âœ… Arquivo compactado com sucesso."

      - name: ğŸ“¤ Upload do build gerado
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows
          path: sqlcipher-windows.zip
