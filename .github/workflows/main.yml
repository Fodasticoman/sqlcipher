name: Build SQLCipher (Windows MinGW-w64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'SQLCipher tag (ex: v4.10.0)'
        required: true
        default: 'v4.10.0'

jobs:
  build-win:
    runs-on: windows-latest
    steps:
      - name: ðŸ§© Baixar cÃ³digo-fonte SQLCipher
        run: |
          git clone https://github.com/sqlcipher/sqlcipher.git
          cd sqlcipher
          git checkout ${{ github.event.inputs.tag }}

      - name: âš™ï¸ Instalar MSYS2 e dependÃªncias
        shell: pwsh
        run: |
          echo "ðŸ”¹ Instalando MSYS2..."
          choco install msys2 --no-progress -y
          echo "ðŸ”¹ Instalando pacotes necessÃ¡rios..."
          C:\msys64\usr\bin\bash -lc 'pacman -S --noconfirm --needed mingw-w64-x86_64-gcc mingw-w64-x86_64-openssl make autoconf automake libtool pkgconf tcl rsync'

      - name: ðŸ—ï¸ Gerar arquivos sqlite3.c e shell.c manualmente
        shell: pwsh
        run: |
          echo "ðŸ”¹ Gerando arquivos sqlite3.c e shell.c manualmente..."
          $repoDir = Join-Path (Get-Location).Path "sqlcipher"
          $bashDir = $repoDir.Replace('\', '/')
          C:\msys64\usr\bin\bash -lc "cd \"$bashDir\" && \
            mkdir -p build && \
            echo 'ðŸ”¹ Copiando arquivos necessÃ¡rios...' && \
            rsync -a --exclude 'build' ./ ./build/ && \
            cd build && \
            echo 'ðŸ”¹ Executando tclsh para gerar sqlite3.c...' && \
            tclsh ../tool/mksqlite3c.tcl > sqlite3.c && \
            echo 'ðŸ”¹ Copiando shell.c...' && \
            cp ../src/shell.c shell.c && \
            echo 'âœ… sqlite3.c e shell.c gerados com suc
