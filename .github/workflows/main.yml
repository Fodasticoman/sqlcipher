name: Build SQLCipher (Windows MinGW-w64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'SQLCipher tag (ex: v4.10.0)'
        required: true
        default: 'v4.10.0'

jobs:
  build-win:
    runs-on: windows-latest

    steps:
      - name: Checkout repositÃ³rio
        uses: actions/checkout@v4

      - name: Instalar MSYS2 e dependÃªncias
        run: |
          choco install msys2 --no-progress -y
          C:\tools\msys64\usr\bin\bash -lc "pacman -Syu --noconfirm"
          C:\tools\msys64\usr\bin\bash -lc "
            pacman -S --noconfirm \
              base-devel \
              mingw-w64-x86_64-gcc \
              mingw-w64-x86_64-openssl \
              mingw-w64-x86_64-tcl \
              mingw-w64-x86_64-pkg-config
          "

      - name: Baixar SQLCipher
        run: |
          echo "ðŸ”¹ Baixando SQLCipher..."
          curl -L -o sqlcipher.zip https://github.com/sqlcipher/sqlcipher/archive/refs/tags/${{ github.event.inputs.tag }}.zip
          tar -xf sqlcipher.zip
          ren sqlcipher-* sqlcipher

      - name: Compilar SQLCipher (DLL e EXE)
        run: |
          echo "ðŸ”¹ Compilando SQLCipher..."
          C:\tools\msys64\usr\bin\bash -lc "
            cd /d/a/${{ github.event.repository.name }}/sqlcipher

            echo 'ðŸ”¹ Ajustando PATH...'
            export PATH=/mingw64/bin:\$PATH

            echo 'ðŸ”¹ Compilando biblioteca principal...'
            gcc -DSQLITE_HAS_CODEC \
                -DSQLITE_TEMP_STORE=2 \
                -DSQLITE_EXTRA_INIT=sqlcipher_extra_init \
                -DSQLITE_EXTRA_SHUTDOWN=sqlcipher_extra_shutdown \
                -DHAVE_STDINT_H \
                -I. \
                -IC:/tools/msys64/mingw64/include \
                sqlite3.c \
                -shared -o sqlcipher.dll \
                -L/mingw64/lib -lcrypto -lssl

            echo 'ðŸ”¹ Compilando executÃ¡vel CLI...'
            gcc shell.c -o sqlcipher.exe \
                -I. -DSQLITE_HAS_CODEC -DSQLITE_TEMP_STORE=2 \
                -DSQLITE_EXTRA_INIT=sqlcipher_extra_init \
                -DSQLITE_EXTRA_SHUTDOWN=sqlcipher_extra_shutdown \
                -DHAVE_STDINT_H \
                -L. -lsqlcipher -L/mingw64/lib -lcrypto -lssl
          "

      - name: Empacotar artefatos
        run: |
          echo "ðŸ”¹ Compactando arquivos compilados..."
          powershell Compress-Archive -Path sqlcipher/sqlcipher.dll,sqlcipher/sqlcipher.exe -DestinationPath sqlcipher_build.zip

      - name: Publicar artefatos
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows-build
          path: sqlcipher_build.zip
