name: Build SQLCipher (Windows MinGW-w64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'SQLCipher tag (ex: v4.10.0)'
        required: true
        default: 'v4.10.0'

jobs:
  build-win:
    runs-on: windows-latest

    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4

      - name: Instalar MSYS2 e depend√™ncias
        run: |
          choco install msys2 --no-progress -y
          C:\tools\msys64\usr\bin\bash -lc "pacman -Syu --noconfirm"
          C:\tools\msys64\usr\bin\bash -lc "
            pacman -S --noconfirm \
              base-devel \
              make \
              mingw-w64-x86_64-gcc \
              mingw-w64-x86_64-openssl \
              autoconf \
              automake \
              libtool \
              tcl
          "

      - name: Baixar SQLCipher
        shell: pwsh
        run: |
          echo "üîπ Baixando SQLCipher..."
          curl -L -o sqlcipher.zip https://github.com/sqlcipher/sqlcipher/archive/refs/tags/${{ github.event.inputs.tag }}.zip
          tar -xf sqlcipher.zip
          $folder = Get-ChildItem -Directory | Where-Object { $_.Name -like 'sqlcipher-*' } | Select-Object -First 1
          if (-not $folder) { throw "‚ùå Diret√≥rio sqlcipher-* n√£o encontrado!" }
          Rename-Item -Path $folder.FullName -NewName "sqlcipher"

      - name: Gerar arquivos sqlite3.c e shell.c
        shell: pwsh
        run: |
          echo "üîπ Gerando arquivos sqlite3.c e shell.c..."
          $workdir = "${{ github.workspace }}\\sqlcipher"
          C:\tools\msys64\usr\bin\bash -lc "
            cd \"${workdir//\\//}\"
            autoreconf -fi || true
            ./configure --enable-tempstore=yes --enable-fts5
            make sqlite3.c shell.c || true
            if [ ! -f sqlite3.c ]; then echo '‚ùå sqlite3.c n√£o foi gerado!'; fi
            if [ ! -f shell.c ]; then echo '‚ùå shell.c n√£o foi gerado!'; fi
          "

      - name: Compilar SQLCipher (DLL e EXE)
        shell: pwsh
        run: |
          echo "üîπ Compilando SQLCipher..."
          $workdir = "${{ github.workspace }}\\sqlcipher"
          C:\tools\msys64\usr\bin\bash -lc "
            cd \"${workdir//\\//}\"
            export PATH=/mingw64/bin:\$PATH

            echo 'üîπ Verificando arquivos...'
            ls -l sqlite3.c shell.c || true

            echo 'üîπ Compilando biblioteca principal (DLL)...'
            gcc -O2 -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL \
                -DSQLITE_TEMP_STORE=2 -DHAVE_STDINT_H \
                -I. \
                sqlite3.c \
                -shared -o sqlcipher.dll \
                -L/mingw64/lib -lcrypto -lssl || exit 1

            echo 'üîπ Compilando execut√°vel CLI...'
            gcc shell.c -o sqlcipher.exe \
                -I. \
                -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL \
                -DSQLITE_TEMP_STORE=2 -DHAVE_STDINT_H \
                -L. -lsqlcipher -L/mingw64/lib -lcrypto -lssl || exit 1

            echo '‚úÖ Compila√ß√£o conclu√≠da.'
          "

      - name: Empacotar artefatos
        shell: pwsh
        run: |
          echo "üîπ Compactando arquivos compilados..."
          if (-not (Test-Path "sqlcipher/sqlcipher.dll")) { throw "‚ùå sqlcipher.dll n√£o encontrado!" }
          if (-not (Test-Path "sqlcipher/sqlcipher.exe")) { throw "‚ùå sqlcipher.exe n√£o encontrado!" }
          Compress-Arc
