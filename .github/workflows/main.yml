name: Build SQLCipher (Windows MinGW-w64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'SQLCipher tag (ex: v4.10.0)'
        required: true
        default: 'v4.10.0'

jobs:
  build-win:
    runs-on: windows-latest

    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4

      - name: Instalar MSYS2 e depend√™ncias
        run: |
          choco install msys2 --no-progress -y
          C:\tools\msys64\usr\bin\bash -lc "pacman -Syu --noconfirm"
          C:\tools\msys64\usr\bin\bash -lc "
            pacman -S --noconfirm \
              base-devel \
              make \
              mingw-w64-x86_64-gcc \
              mingw-w64-x86_64-openssl \
              autoconf \
              automake \
              libtool \
              tcl
          "

      - name: Baixar SQLCipher
        shell: pwsh
        run: |
          echo "üîπ Baixando SQLCipher..."
          curl -L -o sqlcipher.zip https://github.com/sqlcipher/sqlcipher/archive/refs/tags/${{ github.event.inputs.tag }}.zip
          tar -xf sqlcipher.zip
          $folder = Get-ChildItem -Directory | Where-Object { $_.Name -like 'sqlcipher-*' } | Select-Object -First 1
          if (-not $folder) { throw "‚ùå Diret√≥rio sqlcipher-* n√£o encontrado!" }
          Rename-Item -Path $folder.FullName -NewName "sqlcipher"

      - name: Verificar arquivos-fonte
        shell: pwsh
        run: |
          echo "üîπ Verificando se arquivos sqlite3.c e shell.c existem..."
          Get-ChildItem -Recurse -Filter sqlite3.c
          Get-ChildItem -Recurse -Filter shell.c

      - name: Compilar SQLCipher (DLL e EXE)
        shell: pwsh
        run: |
          echo "üîπ Compilando SQLCipher..."
          $workdir = "${{ github.workspace }}\\sqlcipher"
          C:\tools\msys64\usr\bin\bash -lc "
            cd \"${workdir//\\//}\"
            export PATH=/mingw64/bin:\$PATH

            echo 'üîπ Compilando biblioteca principal (DLL)...'
            gcc -O2 -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL \
                -DSQLITE_TEMP_STORE=2 -DHAVE_STDINT_H \
                -I./src \
                ./src/sqlite3.c \
                -shared -o sqlcipher.dll \
                -L/mingw64/lib -lcrypto -lssl || exit 1

            echo 'üîπ Compilando execut√°vel CLI...'
            gcc ./src/shell.c -o sqlcipher.exe \
                -I./src \
                -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL \
                -DSQLITE_TEMP_STORE=2 -DHAVE_STDINT_H \
                -L. -lsqlcipher -L/mingw64/lib -lcrypto -lssl || exit 1

            echo '‚úÖ Compila√ß√£o conclu√≠da.'
            ls -lh sqlcipher.dll sqlcipher.exe || true
          "

      - name: Empacotar artefatos
        shell: pwsh
        run: |
          echo "üîπ Compactando arquivos compilados..."
          if (-not (Test-Path "sqlcipher/sqlcipher.dll")) { throw "‚ùå sqlcipher.dll n√£o encontrado!" }
          if (-not (Test-Path "sqlcipher/sqlcipher.exe")) { throw "‚ùå sqlcipher.exe n√£o encontrado!" }
          Compress-Archive -Path sqlcipher/sqlcipher.dll,sqlcipher/sqlcipher.exe -DestinationPath sqlcipher_build.zip

      - name: Publicar artefatos
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows-build
          path: sqlcipher_build.zip
