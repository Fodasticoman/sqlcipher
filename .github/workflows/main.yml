name: Build SQLCipher Windows

on:
  workflow_dispatch:

jobs:
  build-sqlcipher:
    runs-on: windows-latest

    steps:
      - name: üîπ Verificar reposit√≥rio
        uses: actions/checkout@v4

      - name: üß∞ Instalar MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-tcl
            git
            make
          msystem: MINGW64

      - name: ‚öôÔ∏è Compilar SQLCipher
        shell: msys2 {0}
        env:
          TAG: v4.10.0
          MSYSTEM: MINGW64
          MSYS2_ARG_CONV_EXCL: "*"
        run: |
          set -euo pipefail

          echo "üîπ Clonando SQLCipher tag: $TAG"
          rm -rf sqlcipher || true
          git clone https://github.com/sqlcipher/sqlcipher.git sqlcipher
          cd sqlcipher
          git fetch --tags --quiet || true
          git checkout "$TAG" || git checkout "tags/$TAG" || true

          echo "‚úÖ Reposit√≥rio pronto (tag $TAG)"
          git rev-parse --short HEAD

          install_dir="$(pwd)/build/install"
          mkdir -p "$install_dir"

          echo "üîπ Configurando flags..."
          export CFLAGS=-O2
          export CFLAGS="$CFLAGS -DSQLITE_HAS_CODEC -DSQLCIPHER_CRYPTO_OPENSSL"
          export CFLAGS="$CFLAGS -DSQLITE_THREADSAFE=1 -DSQLITE_TEMP_STORE=2"
          export CFLAGS="$CFLAGS -DSQLITE_EXTRA_INIT=sqlcipher_extra_init"
          export CFLAGS="$CFLAGS -DSQLITE_EXTRA_SHUTDOWN=sqlcipher_extra_shutdown"
          export CFLAGS="$CFLAGS -I/mingw64/include"

          export LDFLAGS="-L/mingw64/lib -lssl -lcrypto -lz"

          echo "CFLAGS: $CFLAGS"
          echo "LDFLAGS: $LDFLAGS"

          echo "üîπ Executando ./configure..."
          ./configure \
            --prefix=$install_dir \
            --enable-shared \
            --enable-static \
            --disable-tcl \
            CFLAGS="$CFLAGS" \
            LDFLAGS="$LDFLAGS" \
            || { echo "‚ö†Ô∏è configure falhou"; cat config.log || true; exit 1; }

          echo "üîπ Compilando com make..."
          make -j"$(nproc)" || { echo "‚ùå make falhou"; exit 1; }

          echo "üîπ Instalando..."
          make install || { echo "‚ùå make install falhou"; exit 1; }

          echo "‚úÖ Build completo!"
          echo "üì¶ Artefatos instalados em: $install_dir"

      - name: üì¶ Enviar artefatos
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows
          path: sqlcipher/build/install
